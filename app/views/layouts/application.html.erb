<!DOCTYPE html>
<html ng-app="WebTemplate">
    <head>
        <title><%= full_title(yield(:page_title)) %></title>
        <%= stylesheet_link_tag 'application', media: 'all' %>
        <%= javascript_include_tag 'application' %>
        <%= csrf_meta_tags %>
        <%= render 'layouts/shim' %>
    </head>
    <body>
        <%= render 'layouts/header' %>
        <br/><h1 class="app-title">GITHUB PROFILER</h1><br/>
        <%= yield %>
        <%= render 'layouts/footer' %>
        <script>              
            <% if current_user != nil %>
                var current_user_email = "<%= current_user.email %>";
                var current_user_username = "<%= current_user.username %>";
                var auth_token = "?access_token=<%= Rails.application.secrets.github_api_token %>"
                var app = angular.module('WebTemplate', []);
                app.controller('GitProfileController', ['$scope', '$http', function($scope, $http) {
                    $http.get('https://api.github.com/users/' + current_user_username + auth_token).
                    success(function(profileData) {
                        $(".github-profile").removeClass('hidden')
                        $scope.username = profileData.login;
                        $scope.name = profileData.name || "n/a";
                        $scope.location = profileData.location || "n/a";
                        $scope.email = profileData.email || current_user_email || "n/a";
                        $scope.html_url = profileData.html_url;
                        $scope.user_avatar = profileData.avatar_url;
                        $scope.date = profileData.created_at;
                        $scope.publicRepos = profileData.public_repos || "0";
                        $scope.following = profileData.following || "0";
                        $scope.followers = profileData.followers || "0";
                    }).error(function(profileData) {
                        $scope.name = "n/a";
                        $scope.location = "n/a";
                        $scope.avatar = "github_avatar.png";
                        $scope.username = "n/a";
                        $scope.email = "n/a";
                        $scope.html_url = "n/a";
                        $scope.date = "n/a";
                        $scope.publicRepos = "n/a";
                        $scope.following = "n/a";
                        $scope.followers = "n/a";
                    });
                }]);
            <% else %>
                var app = angular.module('WebTemplate', []);
            <% end %> 

            app.controller('GitSearchController', ['$scope', '$http', function($scope, $http) {
                $scope.loadUser = function() {
                    var auth_token = "?access_token=<%= Rails.application.secrets.github_api_token %>"
                    if ($scope.username_input) {
                        $http.get('https://api.github.com/users/' + $scope.username_input + auth_token).
                        success(function(userData) {
                            $("#save-profile").removeClass('disable_button');
                            $("#save-profile").val("Save Profile");
                            <% if current_user != nil %>
                                document.getElementById('save-profile').disabled = false;
                            <% end %> 
                            // $("#save-profile").removeClass('hide');
                            $(".aaaa").addClass('show');
                            $(".aaaa").removeClass('hidden');
                            $scope.username = userData.login;
                            $scope.name = userData.name || "n/a";
                            $scope.location = userData.location || "n/a";
                            $scope.email = userData.email || "n/a";
                            $scope.html_url = userData.html_url;
                            $scope.avatar = userData.avatar_url || "";
                            $scope.date = userData.created_at;
                            $scope.publicRepos = userData.public_repos || "0";
                            $scope.following = userData.following || "0";
                            $scope.followers = userData.followers || "0";
                            $('#result_message').text("");
                        }).error(function(userData) {
                            $(".aaaa").addClass('hidden');
                            $(".aaaa").removeClass('show');
                            $('#result_message').text("Sorry, there\'s no Github user " + $scope.username_input);
                        }).finally(function() {
                            $scope.username_input = '';
                        });
                    };
                };

                $scope.saveProfile = function() {
                    <% if current_user != nil %>
                        url = ("/create_gitlink" + "/<%= current_user.id %>/" + $scope.username);
                        $http.post(url).
                        success(function(saveResult) {
                            $("#save-profile").val("Profile saved");
                            $("#save-profile").addClass('disable_button');
                            document.getElementById('save-profile').disabled = 'disabled';
                            // $("#save-profile").addClass('hide')
                            console.log("Profile successfully saved!");
                            $('#result_message').text("Profile successfully saved!");
                        }).error(function(saveResult) {
                            $('#result_message').text("Profile could not be saved");
                        });
                   <% end %> 
                };
            }]);
        </script>
    </body>
</html>


